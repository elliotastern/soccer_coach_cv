# Viewing the 2D Map Report

How to open the 2D map manual-mark report in your browser so it works every time.

## Purpose

View the 2D map report (frame + 2D pitch diagram per frame) generated by `test_2dmap_manual_mark.py`.

## Prerequisites

- Report already generated: `data/output/2dmap_manual_mark/test_2dmap_manual_mark.html` and `data/output/2dmap_manual_mark/frames/` exist.
- To regenerate the report **without** opening the mark UI, run: `python scripts/test_2dmap_manual_mark.py --use-saved` (uses existing `manual_marks.json`). Default model: `models/checkpoint_best_total_after_100_epochs.pth`.
- If the report does not exist yet: from project root run the same command; it requires `manual_marks.json` in that folder, or run with `--mark --web` first to create marks.
- **Player bounding boxes (left column):** To show green player boxes on the frame images, install `rfdetr` and `torch` (e.g. `pip install -r requirements.txt` or `pip install rfdetr`). Either place a trained checkpoint in `models/` (e.g. `checkpoint_best_total_after_100_epochs.pth`, see README) or rely on rfdetr COCO weights. If the report shows "Player bounding boxes: not available", install dependencies and ensure a model is available, then re-run the script so the report and frame images are regenerated with boxes.

## Start the server (required)

1. **From project root:** `cd /path/to/soccer_coach_cv`.
2. **Port 8080.** Run one of:
   - `python serve_viewer_flask.py` (needs `flask`, `flask-cors`), or
   - `python serve_viewer.py` (no extra deps).
3. Leave the process running; do not close the terminal.

## Open in browser

- **Short:** http://localhost:8080/2dmap
- **Long:** http://localhost:8080/data/output/2dmap_manual_mark/test_2dmap_manual_mark.html

## If "connection reset" or page won't load

1. **Confirm the server is running.** In a terminal, from project root run:
   ```bash
   cd /path/to/soccer_coach_cv
   python serve_viewer_flask.py
   ```
   You should see "Running on http://0.0.0.0:8080" (or similar). **Leave that terminal open.** If you close it, the server stops and the browser will get "connection reset".

2. **Try the index page first.** Open http://localhost:8080/ in the browser. If you see "Annotation Viewer Server" and a list of links, the server is working. Then try http://localhost:8080/2dmap.

3. **macOS + Firefox:** If the connection is reset and the server is running, grant Firefox access: **System Settings > Privacy & Security > Local Network** and ensure Firefox is allowed. Or try **Safari** or **Chrome** to see if the problem is Firefox-only.

4. **If the system firewall blocks the server:** Run the server bound to localhost only (no other machine can connect):
   ```bash
   python serve_viewer_flask.py --host 127.0.0.1
   ```
   Then open http://127.0.0.1:8080/2dmap in the browser.

5. **Different port:** If 8080 is in use or blocked, pick another:
   ```bash
   python serve_viewer_flask.py --port 9000
   ```
   Then open http://localhost:9000/2dmap.

## If report is missing

- Run `python scripts/test_2dmap_manual_mark.py --use-saved` from project root.
- If that fails (e.g. no marks), run `python scripts/test_2dmap_manual_mark.py --mark --web`, open http://localhost:5006/mark_ui.html, place center and corners, save, then regenerate with `--use-saved`.

## Best 2D positions (marking corners)

For best 2D positions on the map, mark **all 4 corners of the visible pitch** (Corner 1 = Top-Left, 2 = Top-Right, 3 = Bottom-Right, 4 = Bottom-Left) plus Center. If you only mark 2 corners + center and skip 3 and 4, the inferred quad may not cover the full field; some players will still appear on the map but may be drawn at the map edge (clamped) until you mark all 4 corners.
