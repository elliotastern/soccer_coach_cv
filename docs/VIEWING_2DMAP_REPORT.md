# Viewing the 2D Map Report

How to open the 2D map manual-mark report in your browser so it works every time.

## Purpose

View the 2D map report (frame + 2D pitch diagram per frame) generated by `test_2dmap_manual_mark.py`.

## Prerequisites

- Report already generated: `data/output/2dmap_manual_mark/test_2dmap_manual_mark.html` and `data/output/2dmap_manual_mark/frames/` exist.
- To regenerate the report **without** opening the mark UI, run: `python scripts/test_2dmap_manual_mark.py --use-saved` (uses existing `manual_marks.json`). Default model: `models/checkpoint_best_total_after_100_epochs.pth`.
- If the report does not exist yet: from project root run the same command; it requires `manual_marks.json` in that folder, or run with `--mark --web` first to create marks.
- **Player bounding boxes (left column):** To show green player boxes on the frame images, install `rfdetr` and `torch` (e.g. `pip install -r requirements.txt` or `pip install rfdetr`). Either place a trained checkpoint in `models/` (e.g. `checkpoint_best_total_after_100_epochs.pth`, see README) or rely on rfdetr COCO weights. If the report shows "Player bounding boxes: not available", install dependencies and ensure a model is available, then re-run the script so the report and frame images are regenerated with boxes.

## Start the server (required)

1. **From project root:** `cd /path/to/soccer_coach_cv`.
2. **Port 8080.** Run one of:
   - `python serve_viewer_flask.py` (needs `flask`, `flask-cors`), or
   - `python serve_viewer.py` (no extra deps).
3. Leave the process running; do not close the terminal.

## Open in browser

- **Short:** http://localhost:8080/2dmap
- **Long:** http://localhost:8080/data/output/2dmap_manual_mark/test_2dmap_manual_mark.html
- **Pitch diagram reference (full FIFA terminology):** Run `python scripts/test_pitch_diagram.py` once, then open **http://localhost:8080/pitch_diagram** (or the same forwarded URL you use for /2dmap). If you see "connection reset", use the URL from **View → Ports** for port 8080, not plain localhost.

## If "connection reset" or page won't load

1. **Confirm the server is running.** In a terminal, from project root run:
   ```bash
   cd /path/to/soccer_coach_cv
   python serve_viewer_flask.py
   ```
   You should see "Running on http://127.0.0.1:8080" or "Running on http://0.0.0.0:8080". **Leave that terminal open.** If you close it, the server stops and the browser will get "connection reset".

2. **Cursor / VS Code remote (dev container):** The server defaults to binding `0.0.0.0` so port forwarding works. **Forward port 8080**: **View → Ports** (or **Ports** tab), add port **8080** if needed, then open the URL your IDE shows for that port (e.g. "Open in Browser" on the forwarded port). Do not use `http://localhost:8080` from the host until the port is forwarded; use the URL from the Ports panel.

3. **Try the index page first.** Open the 8080 URL in the browser (forwarded URL if remote). If you see "Annotation Viewer Server" and a list of links, the server is working. Then try `/2dmap` on the same host/port.

4. **macOS + Firefox:** If the connection is reset and the server is running, grant Firefox access: **System Settings > Privacy & Security > Local Network** and ensure Firefox is allowed. Or try **Safari** or **Chrome** to see if the problem is Firefox-only.

5. **If you want localhost-only (no port forward):** Run the server bound to localhost:
   ```bash
   python serve_viewer_flask.py --host 127.0.0.1
   ```
   Then open http://127.0.0.1:8080/2dmap in the browser.

6. **Different port:** If 8080 is in use or blocked, pick another:
   ```bash
   python serve_viewer_flask.py --port 9000
   ```
   Then open http://localhost:9000/2dmap.

## If report is missing

- Run `python scripts/test_2dmap_manual_mark.py --use-saved` from project root.
- If that fails (e.g. no marks), run `python scripts/test_2dmap_manual_mark.py --mark --web`, open the marking UI (see below), place 4 corners and halfway line, save, then regenerate with `--use-saved`.

## Marking UI (4 corners + halfway line) – avoid "Unable to connect"

**Recommended (one port, works on remote Cursor/VS Code):**

1. Generate the mark UI once: `python scripts/test_2dmap_manual_mark.py --mark --web` (you can Ctrl+C after it prints the URL, or let it run).
2. Start the **viewer server**: `python serve_viewer_flask.py` (or `python serve_viewer.py`). Leave that terminal open.
3. **Forward port 8080** in Cursor: **View → Ports → Forward a Port → 8080**.
4. Open **http://localhost:8080/mark_ui** in your browser. Use the URL **without** a trailing slash: `http://localhost:8080/mark_ui` (not `/mark_ui/`). The marking UI is served on the same port as the report, so you only forward 8080 once.
5. Mark the 6 spots and click Save. Then run: `python scripts/test_2dmap_manual_mark.py --use-saved`.

This prevents "Unable to connect" because you use the same server (and port 8080) for both the 2D map report and the marking UI; no separate port 5006 is needed.

**If you prefer port 5006:** Forward port 5006 in Cursor (View → Ports → Forward a Port → 5006), then open http://localhost:5006/mark_ui.html. Or run `python scripts/serve_2dmap_mark_ui.py` and forward 5006.

## Best 2D positions (marking corners)

For best 2D positions on the map, mark **all 4 corners of the visible pitch** (Corner 1 = Top-Left, 2 = Top-Right, 3 = Bottom-Right, 4 = Bottom-Left) plus Center. If you only mark 2 corners + center and skip 3 and 4, the inferred quad may not cover the full field; some players will still appear on the map but may be drawn at the map edge (clamped) until you mark all 4 corners.
